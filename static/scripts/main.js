var upload_form = document.getElementById("upload-form");
var file_uploader = document.getElementById("file-uploader");
var loader = document.getElementById("loader");
var fader = document.getElementById("fader");
var init = document.getElementById("init");
var msg_error = document.getElementById("error-msg");
var error_board = document.getElementById("error");
var result_board = document.getElementById("results-div");


// check if there is a file selected then enable the submit button
file_uploader.addEventListener("change", function () {
    if (file_uploader.files.length > 0) {
        submit_btn.disabled = false;
    } else {
        submit_btn.disabled = true;
    }
});

upload_form.addEventListener("submit", function (event) {
    event.preventDefault();
    
    showLoader(true);
    submit_btn.disabled = true;
    init.style.display = "none";
    error_board.style.display = "none";
    result_board.style.display = "none";

    const formData = new FormData(upload_form);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/', true);
    xhr.onload = function () {
        if (xhr.status === 200) {
            upload_form.reset();
            var response = JSON.parse(xhr.responseText);

            if (response.success) {
                showLoader(false);
                result_board.style.display = "block";

                update_display(response.results.prediction, response.results.confidence);

            } else {
                showLoader(false);
                error_board.style.display = "block";

                msg_error.innerHTML = response.message;
            }
        } else {
            alert('An Internal error occurred.');
        }
    };
    xhr.send(formData);
});

// Function to update the display
function update_display(family, confidence) {
    var result = document.getElementById("result");
    var word = ''

    if (confidence < 40) {
        result.innerHTML = "We are not confident enough to make a prediction on the sample you uploaded.";
        return;
    }

    if (confidence > 95) {
        word = "highly likely";
    } else if (confidence > 70) {
        word = "likely";
    } else {
        word = "possibly";
    }

    result.innerHTML = "Based on the analysis, we are <b>" + confidence + "%</b> confident that the sample is <b>" + word +
                    "</b> from the <b>" + family + "</b> family.";
}

// Function to reset the display
function showLoader(show) {
    if (show) {
        loader.style.display = "block";
        fader.style.opacity = 0;
    } else {
        loader.style.display = "none";
        fader.style.opacity = 1;
    }
}