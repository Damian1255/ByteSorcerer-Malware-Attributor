var upload_form = document.getElementById("upload-form");
var file_uploader = document.getElementById("file-uploader");
var loader = document.getElementById("loader");
var fader = document.getElementById("fader");
var init = document.getElementById("init");
var msg_error = document.getElementById("error-msg");
var error_board = document.getElementById("error");
var result_board = document.getElementById("results-div");
var path = '/staticmodel';


// Check if there is a file selected then enable the submit button
file_uploader.addEventListener("change", function () {
    if (file_uploader.files.length > 0) {
        submit_btn.disabled = false;
    } else {
        submit_btn.disabled = true;
    }
});


// Form event listener to handle the form submission
upload_form.addEventListener("submit", function (event) {
    event.preventDefault();
    
    // Display the loader and disable the submit button
    showLoader(true);
    submit_btn.disabled = true;
    init.style.display = "none";
    error_board.style.display = "none";
    result_board.style.display = "none";

    // Send the form data to the server
    const formData = new FormData(upload_form);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', path, true);
    
    xhr.onload = function () {
        upload_form.reset();

        // Check if the request was successful
        if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);

            // Check if the server responsed with a success message
            if (response.success) {
                showLoader(false);
                result_board.style.display = "block";
                update_display(response);

            } else {
                showLoader(false);
                error_board.style.display = "block";
                msg_error.innerHTML = response.message;
            }

        } else {
            alert('An Internal error occurred. Please try again later.');
            showLoader(false);
            init.style.display = "block";
            error_board.style.display = "none";
        }
    };

    // Send the form data to the server
    xhr.send(formData);
});


// Function to update the display
function update_display(response) {
    var result_div = document.getElementById("result");

    // Display the results based on the method used
    if (response.method == 'static') {
        var confidence = response.results.confidence;
        var keyword = ''
        if (confidence < 45) {
            message = "We are not confident enough to make a prediction on the sample you uploaded." +
                        "<br><br>Please try again with a different sample or method.";
            result_div.innerHTML = message;
            return;
        }
        if (confidence > 95) {
            keyword = "highly likely";
        } else if (confidence > 70) {
            keyword = "likely";
        } else {
            keyword = "possibly";
        }

        result_div.innerHTML = "The uploaded sample is <b>" + keyword + "</b> from the malware family of <b>"
                            + response.results.prediction + "</b> in our database." +
                            "<ul><li>Model predicted with <b>" + confidence + "%</b> confidence.</li></ul>";
                        
    } else if (response.method == 'traits') {
        var family = response.results.prediction[0].family
        var count = response.results.prediction[0].count

        if (count > 0) {
            result_div.innerHTML = "The sample has most common traits with <b>"
                                + family + "</b> family of malwares in our database.";

            var list = ''
            for (var i = 0; i < response.results.prediction.length; i++) {
                family = response.results.prediction[i].family
                count = response.results.prediction[i].count
                if (count > 0) {
                    list += '<li><b>' + count + '</b> traits in common with <b>' + family + '</b></li>';
                }
            }
            result_div.innerHTML += '<ul>' + list + '</ul>';
        }
        else {
            result_div.innerHTML = "We are unable to find common traits with any malware family in our database.";
        }
    }

    
    // Add the file name and method used to the display
    var file_name = response.results.file;
    var model = response.results.method;
    var message = "<span style='margin-top:30px;'>Method: " + model + "</span>" + 
                    "<span>Sample: " + file_name + "</span>";
    result_div.innerHTML += message;
}


// Function to reset the display
function showLoader(show) {
    if (show) {
        loader.style.display = "block";
        fader.style.opacity = 0;
    } else {
        loader.style.display = "none";
        fader.style.opacity = 1;
    }
}


// Function to handle the toggle switch
let toggleSwitch = document.getElementsByClassName('redButton')[0]
let versionOuterContainer = document.getElementById('version-outerContainer');
let versionTraitOuterContainer = document.getElementById('version-outerContainer-traits');
let versionSelectorContainer = document.getElementsByClassName('version-selector-container')[0]
let tooltip = document.getElementsByClassName('tool-tip')[1]

function option_static(e) {
    toggleSwitch.classList.add('horizTranslate1');
    toggleSwitch.classList.remove('horizTranslate2');
    toggleSwitch.classList.remove('horizTranslate3');
    transition(hide=false, show = 'm1');
    path = '/staticmodel';
    e.style.color = 'white';
}

function option_traits(e) {
    toggleSwitch.classList.add('horizTranslate2');
    toggleSwitch.classList.remove('horizTranslate3');
    toggleSwitch.classList.remove('horizTranslate1');
    transition(hide=false, show = 'm2');
    path = '/comparetraits';
    e.style.color = 'white';
}

function option_cfg(e) {
    toggleSwitch.classList.add('horizTranslate3');
    toggleSwitch.classList.remove('horizTranslate2');
    toggleSwitch.classList.remove('horizTranslate1');
    transition(hide=true);
    path = '/cfgmodel';
    e.style.color = 'white';
}

// Function to handle the toggle switch
let versionToggleSwitch = document.getElementsByClassName('version-redButton')[0]
function model_lite_option(e) {
    versionToggleSwitch.classList.add('horizTranslate1');
    versionToggleSwitch.classList.remove('horizTranslate2');
    versionToggleSwitch.classList.remove('horizTranslate3');
    document.getElementById('model_type').value = 'lite';
    resetColor('version-legendText');
    e.style.color = 'white';
}

function model_full_option(e) {
    versionToggleSwitch.classList.add('horizTranslate2');
    versionToggleSwitch.classList.remove('horizTranslate3');
    versionToggleSwitch.classList.remove('horizTranslate1');
    document.getElementById('model_type').value = 'full';
    resetColor('version-legendText');
    e.style.color = 'white';
}

// Function to handle the toggle switch
let traitsToggleSwitch = document.getElementsByClassName('version-redButton-traits')[0]
function traits_partial_option(e) {
    traitsToggleSwitch.classList.add('horizTranslate1');
    traitsToggleSwitch.classList.remove('horizTranslate2');
    traitsToggleSwitch.classList.remove('horizTranslate3');
    document.getElementById('method_type').value = 'partial';
    resetColor('version-legendText-traits');
    e.style.color = 'white';
}

function traits_full_option(e) {
    traitsToggleSwitch.classList.add('horizTranslate2');
    traitsToggleSwitch.classList.remove('horizTranslate3');
    traitsToggleSwitch.classList.remove('horizTranslate1');
    document.getElementById('method_type').value = 'full';
    resetColor('version-legendText-traits');
    e.style.color = 'white';
}

function resetColor(className) {
    let options = document.getElementsByClassName(className);
    for (let i = 0; i < options.length; i++) {
        options[i].style.color = 'black';
    }
}

// Function to handle the transition effect
function transition(hide = false, show = 'm1') {
    versionOuterContainer.style.opacity = 0;
    versionSelectorContainer.style.margin = 0;
    versionTraitOuterContainer.style.opacity = 0;
    tooltip.style.opacity = 0;
    
    if (!hide) {
        setTimeout(function() {
            if (show == 'm1'){
                versionTraitOuterContainer.style.display = 'none';
                versionOuterContainer.style.display = 'block';
                versionOuterContainer.style.opacity = 1;
                tooltip.getElementsByClassName('tooltiptext-v')[0].style.display = 'block';
                tooltip.getElementsByClassName('tooltiptext-v')[1].style.display = 'none';
            } else {
                versionOuterContainer.style.display = 'none';
                versionTraitOuterContainer.style.display = 'block';
                versionTraitOuterContainer.style.opacity = 1;
                tooltip.getElementsByClassName('tooltiptext-v')[0].style.display = 'none';
                tooltip.getElementsByClassName('tooltiptext-v')[1].style.display = 'block';
            }
            versionSelectorContainer.style.margin = '15px 0 15px 0px';
            tooltip.style.opacity = 1;
        }, 300);
    }

    let options = document.getElementsByClassName('legendText');
    for (let i = 0; i < options.length; i++) {
        options[i].style.color = 'black';
    }
}