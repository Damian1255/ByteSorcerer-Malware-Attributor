import os
from app import app
from flask import jsonify
from werkzeug.utils import secure_filename


def process_file_from_request(request):

    """

    Process the file from the request and save it for processing.

    Parameters:
    - request (obj): The request object.
    
    """
    
    for item in request.files.getlist('file'):
        if item:
            imagename = secure_filename(item.filename)

            # Check if the file is blacklisted
            if '.' in imagename and imagename.rsplit('.', 1)[1].lower() in app.config['BLACKLISTED_EXTENSION']:
                message = """The file uploaded is not supported.
                            Ensure you are uploading an Portable Executable file."""
                return {'valid': False, 'message': message}
        
            # Save the file for processing
            item.save(os.path.join(app.config['UPLOAD_FOLDER'], imagename))

            return {'valid': True, 'filename': imagename}
        else:
            return {'valid': False, 'message': 'No file is uploaded.'}
        

def clear_upload_if_exists(filename):

    """
    Clear the upload folder if the file exists.

    Parameters:
    - filename (str): The file path to check.
    
    """

    if os.path.exists(filename):
        os.remove(filename)


def startup_integrity_check():
    """

    Check the integrity the application and its dependencies.

    """

    # Create upload folder if it does not exist
    if not os.path.exists(app.config['UPLOAD_FOLDER']):
        os.makedirs(app.config['UPLOAD_FOLDER'])

    # Clear the upload folder
    for file in os.listdir(app.config['UPLOAD_FOLDER']):
        os.remove(os.path.join(app.config['UPLOAD_FOLDER'], file))

    return True